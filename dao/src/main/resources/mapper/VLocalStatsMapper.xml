<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.platon.rosettanet.admin.dao.VLocalStatsMapper">
<!--  <resultMap id="BaseResultMap" type="com.platon.rosettanet.admin.dao.entity.VLocalStats">-->
<!--    <result column="carrier_conn_status" jdbcType="VARCHAR" property="carrierConnStatus" />-->
<!--    <result column="data_node_count" jdbcType="BIGINT" property="dataNodeCount" />-->
<!--    <result column="power_node_count" jdbcType="BIGINT" property="powerNodeCount" />-->
<!--    <result column="total_core" jdbcType="DECIMAL" property="totalCore" />-->
<!--    <result column="total_memory" jdbcType="DECIMAL" property="totalMemory" />-->
<!--    <result column="total_bandwidth" jdbcType="DECIMAL" property="totalBandwidth" />-->
<!--    <result column="used_core" jdbcType="DECIMAL" property="usedCore" />-->
<!--    <result column="used_memory" jdbcType="DECIMAL" property="usedMemory" />-->
<!--    <result column="used_bandwidth" jdbcType="DECIMAL" property="usedBandwidth" />-->
<!--    <result column="released_data_file_count" jdbcType="BIGINT" property="releasedDataFileCount" />-->
<!--    <result column="unreleased_data_file_count" jdbcType="BIGINT" property="unreleasedDataFileCount" />-->
<!--    <result column="task_count" jdbcType="BIGINT" property="taskCount" />-->
<!--  </resultMap>-->
<!--  <sql id="Base_Column_List">-->
<!--    carrier_conn_status,-->
<!--    data_node_count,-->
<!--    power_node_count,-->
<!--    total_core,total_memory,total_bandwidth,used_core,used_memory,used_bandwidth,-->
<!--    released_data_file_count,unreleased_data_file_count,-->
<!--    task_count-->
<!--  </sql>-->

<!--  <select id="selectLocalStats" resultMap="BaseResultMap">-->
<!--    select <include refid="Base_Column_List"/>-->
<!--    from v_local_stats-->
<!--  </select>-->

  <!-- 查询总占用资源 -->
  <select id="queryUsedTotalResource" resultType="com.platon.rosettanet.admin.dao.dto.UsedResourceDTO">
    select
        sum(used_core) as usedCore,
        sum(used_memory) as usedMemory,
        sum(used_bandwidth) as usedBandwidth,
        sum(memory) as totalMemory,
        sum(core) as totalCore,
        sum(bandwidth) as totalBandwidth
    from
        local_power_node
  </select>

  <!-- 查询我发布的数据 -->
  <select id="queryMyPublishData" resultType="java.lang.Long">
    select
        IFNULL(sum(b.size), 0) as totalSize
        <!--IFNULL(sum(b.size), 0) / (1024 * 1024 * 1024) as totalSize -->
   from
       v_past_12_month a left join local_meta_data b
       on a.month =  DATE_FORMAT(b.publish_time,'%Y-%m')
       and b.status = 'released'
   group by a.month
   order by a.month desc
  </select>

  <!-- 查询我发布的算力 -->
  <select id="queryMyPublishPower" resultType="java.lang.Long">
      select
          IFNULL(sum(b.memory), 0) as totalMemory
          <!-- IFNULL(sum(b.memory), 0) / (1024 * 1024 * 1024) as totalMemory -->
      from
          v_past_12_month a left join local_power_node b
          on a.month =  DATE_FORMAT(b.start_time,'%Y-%m')
          and b.power_status = 'release'
          and b.conn_status != '-1'
      group by a.month
      order by a.month desc
  </select>

  <!-- 查询我的计算任务概况 -->
  <select id="queryMyCalculateTaskStats" resultType="java.util.HashMap">
    select
        status as status,
        count(status) as statusCount
    from
        task
    group by status
  </select>

  <!-- 查询全网数据总量走势 -->
  <select id="queryWholeNetDateTrend" resultType="java.lang.Long">
    select
        IFNULL(sum(b.size), 0) as totalSize
        <!-- IFNULL(sum(b.size), 0) / (1024 * 1024 * 1024) as totalSize -->
    from
        v_past_12_month a left join global_data_file b
        on a.month =  DATE_FORMAT(b.publish_time,'%Y-%m')
        and b.status = 'released'
    group by a.month
    order by a.month desc
  </select>
  <!-- 查询全网算力总量走势 -->
  <select id="queryWholeNetPowerTrend" resultType="java.lang.Long">
    select
        IFNULL(sum(b.total_Memory), 0) as total_Memory
        <!-- IFNULL(sum(b.total_Memory), 0) / (1024 * 1024 * 1024) as total_Memory -->
    from
        v_past_12_month a left join global_power b
        on a.month =  DATE_FORMAT(b.rec_update_time,'%Y-%m')
    group by a.month
    order by a.month desc
  </select>
  <!-- 查询全网数据总量月环比（上月/上上月）-->
  <select id="queryWholeNetDateRingRatio" resultType="java.lang.Double">
    select
        IFNULL(sum(b.size), 0) as totalSize
        <!-- IFNULL(sum(b.size), 0) / (1024 * 1024 * 1024) as totalSize -->
    from
        (select DATE_FORMAT(CURDATE() - INTERVAL 1 MONTH, '%Y-%m') AS `month`
        UNION select DATE_FORMAT(CURDATE() - INTERVAL 2 MONTH, '%Y-%m') AS `month`) a
        left join global_data_file b
        on a.month = DATE_FORMAT(b.publish_time, '%Y-%m')
        and b.status = 'released'
    group by a.month
    order by a.month desc
  </select>

  <!-- 查询全网数据总量月同比（当前年上月/去年同上月）-->
  <select id="queryWholeNetDateSameRatio" resultType="java.lang.Double">
    select
        IFNULL(sum(b.size), 0) as totalSize
        <!-- IFNULL(sum(b.size), 0) / (1024 * 1024 * 1024) as totalSize -->
    from
        (select DATE_FORMAT(CURDATE() - INTERVAL 1 MONTH, '%Y-%m') AS `month`
        UNION select DATE_FORMAT(CURDATE() - INTERVAL 13 MONTH, '%Y-%m') AS `month`) a
        left join global_data_file b
        on a.month = DATE_FORMAT(b.publish_time, '%Y-%m')
        and b.status = 'released'
    group by a.month
    order by a.month desc
  </select>

  <!-- 查询待授权数据列表-->
  <select id="queryWaitAuthDataList" resultType="com.platon.rosettanet.admin.dao.entity.LocalDataAuth">
    select
        create_at as applyTime,
        apply_user as applyUser,

    from
        local_data_auth
    where status = 0
    order by create_at desc
  </select>

</mapper>