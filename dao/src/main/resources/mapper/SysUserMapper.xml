<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.platon.metis.admin.dao.SysUserMapper">
    <resultMap id="BaseResultMap" type="com.platon.metis.admin.dao.entity.SysUser">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="user_name" jdbcType="VARCHAR" property="userName"/>
        <result column="address" jdbcType="VARCHAR" property="address"/>
        <result column="status" jdbcType="INTEGER" property="status"/>
        <result column="rec_create_time" jdbcType="TIMESTAMP" property="recCreateTime"/>
        <result column="rec_update_time" jdbcType="TIMESTAMP" property="recUpdateTime"/>
        <result column="is_admin" jdbcType="INTEGER" property="isAdmin"/>
    </resultMap>
    <sql id="Base_Column_List">
        id,
        user_name,
        `address`,
        `status`,
        rec_create_time,
        rec_update_time,
        is_admin
    </sql>
    <select id="selectByAddress" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from sys_user
        where address = #{address}
    </select>

    <insert id="insert" parameterType="com.platon.metis.admin.dao.entity.SysUser">
        insert into sys_user (user_name, address, status, rec_create_time, rec_update_time, is_admin)
        values (#{userName}, #{address}, #{status}, #{recCreateTime}, #{recUpdateTime}, #{isAdmin})
    </insert>

    <!-- 如果数据库只剩下一个用户，则将其设置为管理员用户-->
    <update id="updateSingleUserToAdmin">
        update sys_user
        set is_admin = 1
        where EXISTS(select * from (select count(1) count from sys_user) a where a.count = 1)
    </update>

    <update id="updateByAddress" parameterType="com.platon.metis.admin.dao.entity.SysUser">
        update sys_user
        set user_name = #{userName},
            address   = #{address},
            status    = #{status},
            is_admin  = #{isAdmin}
        where address = #{address}
    </update>

    <update id="insertOrUpdateToAdmin">
        insert into sys_user (user_name, address, status, rec_create_time, rec_update_time, is_admin)
        values (#{userName}, #{address}, #{status}, #{recCreateTime}, #{recUpdateTime}, #{isAdmin})
        on duplicate key
            update is_admin = 1
    </update>
</mapper>